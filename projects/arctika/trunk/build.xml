<?xml version="1.0"?>
<project default="all" name="arctika" basedir=".">

    <!--
       PROPERTIES
    -->

    <!-- Project properties -->
    <property name="project.name" value="summa-arctika"/>
    <property name="project.version" value="0.1"/>
    <property name="release" value="${project.name}-${project.version}"/>
    <property name="release.jar" value="${release}.jar"/>
    <property name="release.api.jar" value="${project.name}-api-${project.version}.jar"/>

    <!-- Persistent directories -->
    <property name="src.dir" value="${basedir}/src"/>
    <property name="test.src.dir" value="${basedir}/test"/>

    <!-- Temporary files and directories -->
    <property name="build.dir" value="${basedir}/classes"/>
    <property name="test.build.dir" value="${basedir}/classes-test"/>
    <property name="dist.dir" value="${basedir}/dist"/>
    <property name="doc.dir" value="${basedir}/doc"/>
    <property name="apidocs.dir" value="${doc.dir}/apidocs"/>
    <property name="lib.dir" value="${basedir}/lib"/>
    <property name="tmp.dir" value="${basedir}/tmp"/>

    <!-- Tika standalone setup -->
    <property name="tika.version" value="0.3"/>
    <property name="tika.file" value="tika-${tika.version}-standalone.jar"/>
    <property name="tika.url"
              value="http://people.apache.org/repo/m2-snapshot-repository/org/apache/tika/tika/${tika.version}/${tika.file}"/>

    <!-- Compilation properties -->
    <property name="compiler" value="modern"/>
    <property name="compiler.optimize" value="on"/>
    <property name="compiler.debug" value="on"/>
    <tstamp>
        <format property="build.time" pattern="MM/dd/yyyy HH:mm"/>
    </tstamp>

    <!-- Path definitions -->
    <path id="lib.path">
        <fileset dir="${lib.dir}">
            <include name="**/*.jar"/>
            <exclude name="junit*"/>
        </fileset>
    </path>

    <path id="test.lib.path">
        <path refid="lib.path" />
        <pathelement location="${build.dir}" />
        <pathelement location="${test.build.dir}" />
        <pathelement location="${ant.home}/lib/ant-junit.jar"/>
        <pathelement location="${test.src.dir}"/>
    </path>

    <!-- Store space-separated list of lib-filenames in lib.files -->
    <pathconvert refid="lib.path" property="lib.files" pathsep=" ">
        <map from="${lib.dir}/" to=""/>
    </pathconvert>

    <!-- lib.files : set by the .checkDepends target -->


    <!--
       TARGETS
    -->

    <target name=".phony"><!-- Dummy target --></target>

    <target name="clean">
        <delete dir="${build.dir}"/>
        <delete dir="${test.build.dir}"/>
        <delete dir="${tmp.dir}"/>
        <delete file="${release.jar}"/>
        <delete file="${release.api.jar}"/>
    </target>

    <target name="distclean" depends="clean">
        <delete dir="${dist.dir}"/>
        <delete dir="${apidocs.dir}"/>
    </target>

    <target name=".getTika">
        <!-- Downloads Tika implementation lib and replaces the API-stub.
             Call this after .getLibs to get full Tika functionality.
         -->
        <delete file="${lib.dir}/${tika.file}"/>
        <get src="${tika.url}"
             dest="${lib.dir}/${tika.file}"/>
    </target>

    <target name="checkTikaLibs">
        <!-- Assure that tika-standalone is downloaded -->
        <echo message="Checking whether ${tika.file} is present"/>
        <condition property="getTikaTask" value=".phony" else=".getTika">
            <available file="${lib.dir}/${tika.file}"/>
        </condition>
        <antcall target="${getTikaTask}"/>
    </target>

    <target name="compile">
        <mkdir dir="${build.dir}"/>
        <javac srcdir="${src.dir}" destdir="${build.dir}" encoding="UTF-8"
               compiler="${compiler}" optimize="${compiler.optimize}"
               debug="${compiler.debug}">
            <classpath refid="lib.path"/>
        </javac>
    </target>

    <target name="apidocs" depends="compile">
        <mkdir dir="${apidocs.dir}"/>
        <javadoc
                packagenames="dk.statsbiblioteket.summa.*"
                destdir="${apidocs.dir}"
                author="true"
                version="true"
                access="protected"
                windowtitle="Summa Arctika"
                additionalparam="-breakiterator">

            <classpath refid="lib.path"/>

            <packageset dir="${src.dir}">
                <include name="dk/statsbiblioteket/summa/arctika/**"/>
            </packageset>
        </javadoc>

    </target>

    <target name=".jar" depends="compile">
        <jar basedir="${build.dir}" compress="true" jarfile="${release.jar}"/>
    </target>

    <target name="release" depends="distclean, .jar, apidocs, .getTikaLibs">

        <antcall target="checkTikaLibs"/>

        <mkdir dir="${dist.dir}"/>

        <property name="prefix" value="${release}"/>

        <replaceregexp match="\$Id[^\$]*\$" replace="${project.name}-${project.version} - build date ${build.time}">
            <fileset dir="${doc.dir}" includes="**/*"/>
         </replaceregexp>

        <zip destfile="${dist.dir}/${release}.zip">

            <zipfileset prefix="${prefix}" file="${release.jar}"/>
            <zipfileset prefix="${prefix}" file="${release.api.jar}"/>

            <zipfileset prefix="${prefix}/lib" dir="${lib.dir}">
                <include name="*.jar"/>
            </zipfileset>

            <zipfileset dir="${doc.dir}" prefix="${prefix}/${doc.dir}">
                <include name="**/*"/>
            </zipfileset>

        </zip>

    </target>



    <target name="all" depends="release"/>

</project>


